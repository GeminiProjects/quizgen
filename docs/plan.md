# QuizGen 开发计划

> 更新时间：2025-07-16

## 项目概述

QuizGen（演讲即时智能评测系统）是一个实时互动的校园演讲评测系统。本文档记录了项目的开发计划和技术架构决策。

## 技术决策

### 1. API 架构选择

经过评估，决定使用 **Next.js App Router API Routes** 而非独立的 API 服务：

- ✅ 无需额外部署，与前端一体化
- ✅ 共享认证状态更简单
- ✅ 开发调试方便
- ✅ 对于中等规模项目完全够用
- ⚠️ 注意 Vercel 函数有超时限制（免费版 10 秒，Pro 版 60 秒）

### 2. AI 功能架构

AI 功能将采用分层设计：

```
/packages/ai/          # AI 核心功能包（可复用、易测试）
  ├── gemini.ts       # Gemini API 封装
  ├── quiz-gen.ts     # 题目生成逻辑
  └── transcribe.ts   # 语音转文字

/apps/web/app/api/    # Next.js API Routes（处理 HTTP 请求）
  ├── quiz/generate/  # 调用 packages/ai 生成题目
  └── transcribe/     # 调用 packages/ai 转录语音
```

### 3. 实时通信方案

初期使用 **Server-Sent Events (SSE)**，后期可升级：

- **第一阶段**：SSE + 轮询（实现简单，满足 MVP 需求）
- **第二阶段**：考虑 Pusher/Ably 等第三方服务
- **未来可能**：Cloudflare Durable Objects（需要迁移部署）

## 开发阶段

### 第一阶段：AI 核心功能包（当前）

**目标**：创建可复用的 AI 功能模块

1. **创建 `packages/ai` 包**
   - [ ] 初始化包结构和配置
   - [ ] 集成 Vercel AI SDK
   - [ ] 实现 Gemini Pro API 封装

2. **题目生成功能**
   - [ ] 设计 Prompt 模板
   - [ ] 实现题目生成逻辑
   - [ ] 添加题目质量自检

3. **语音转文字功能**
   - [ ] 集成 Whisper API 或 Gemini
   - [ ] 处理音频流
   - [ ] 实现断句和时间戳

4. **测试和文档**
   - [ ] 编写单元测试
   - [ ] 添加使用示例
   - [ ] 性能优化

### 第二阶段：Next.js API Routes

**目标**：实现所有后端 API 接口

1. **组织管理 API** (`/api/organizations`)
   - [ ] POST - 创建组织
   - [ ] GET - 获取组织列表
   - [ ] PUT - 更新组织信息
   - [ ] POST /verify - 验证组织密码

2. **演讲管理 API** (`/api/lectures`)
   - [ ] POST - 创建演讲
   - [ ] GET - 获取演讲列表
   - [ ] PUT /:id/status - 开始/结束演讲
   - [ ] POST /:id/join - 加入演讲

3. **题目管理 API** (`/api/quiz`)
   - [ ] POST /generate - 生成题目（调用 AI）
   - [ ] GET /lecture/:id - 获取演讲题目
   - [ ] POST /:id/attempt - 提交答案
   - [ ] GET /:id/stats - 获取答题统计

4. **材料和转录 API**
   - [ ] POST /materials/upload - 上传材料
   - [ ] POST /transcribe - 语音转文字
   - [ ] GET /transcripts/:lectureId - 获取转录历史

### 第三阶段：实时功能

**目标**：实现题目推送和状态同步

1. **SSE 实时推送**
   - [ ] `/api/lectures/:id/stream` - 题目推送流
   - [ ] 客户端 EventSource 实现
   - [ ] 重连和错误恢复机制

2. **状态同步**
   - [ ] 答题进度实时更新
   - [ ] 统计数据实时刷新
   - [ ] 演讲状态变更通知

### 第四阶段：前端集成

**目标**：完成所有功能的前后端对接

1. **页面功能完善**
   - [ ] Dashboard 连接真实数据
   - [ ] 演讲者视图完整功能
   - [ ] 听众视图实时更新
   - [ ] 组织管理界面

2. **用户体验优化**
   - [ ] 加载状态和错误处理
   - [ ] 响应式设计完善
   - [ ] 无障碍功能支持

3. **性能优化**
   - [ ] 图片和文件优化
   - [ ] API 请求缓存
   - [ ] 懒加载实现

## 技术规范

### API 设计原则

1. **RESTful 风格**
   - 使用标准 HTTP 方法
   - 资源导向的 URL 设计
   - 统一的错误响应格式

2. **认证和授权**
   - 所有 API 需要认证（除了公开接口）
   - 使用 Better Auth 的 session 验证
   - 基于资源的权限控制

3. **数据验证**
   - 使用 Zod 进行请求体验证
   - 返回清晰的验证错误信息
   - 防止 SQL 注入和 XSS

### 代码组织

1. **模块化设计**
   - 核心逻辑放在 packages
   - API 路由只做请求处理
   - 共享类型定义

2. **错误处理**
   - 统一的错误类型
   - 详细的错误日志
   - 用户友好的错误信息

3. **测试策略**
   - 单元测试覆盖核心逻辑
   - API 集成测试
   - E2E 测试关键流程

## 时间线估算

- **第一阶段**：3-4 天（AI 功能包）
- **第二阶段**：5-7 天（API Routes）
- **第三阶段**：3-4 天（实时功能）
- **第四阶段**：4-5 天（前端集成）

总计：约 15-20 个工作日完成 MVP 版本

## 风险和应对

1. **AI API 限制**
   - 风险：Gemini API 调用限制
   - 应对：实现缓存和降级方案

2. **实时性能**
   - 风险：大量并发用户时的性能问题
   - 应对：优化推送机制，考虑分片

3. **文件上传**
   - 风险：大文件处理和存储成本
   - 应对：限制文件大小，使用对象存储

## 下一步行动

1. 开始创建 `packages/ai` 基础框架
2. 实现第一个 AI 功能（题目生成）
3. 创建对应的 API Route 示例
4. 测试端到端流程